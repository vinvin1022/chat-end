<!DOCTYPE html>
<head>
  <title>OpenAI Quickstart</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {{ bootstrap.load_css() }}
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('main.static', filename='/highlight/styles/atom-one-dark.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('main.static', filename='main.css') }}" />
 
  

  <title>Bootstrap Example</title>
 

</head>

<body>


  <div class="container-fluid">
    <nav class="navbar navbar-top navbar-dark bg-dark fixed-top d-block d-sm-none">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Offcanvas dark navbar</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasDarkNavbar" aria-controls="offcanvasDarkNavbar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="offcanvasDarkNavbar" aria-labelledby="offcanvasDarkNavbarLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasDarkNavbarLabel">Dark offcanvas</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Dropdown
                </a>
                <ul class="dropdown-menu dropdown-menu-dark">
                  <li><a class="dropdown-item" href="#">Action</a></li>
                  <li><a class="dropdown-item" href="#">Another action</a></li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
              </li>
            </ul>
            <form class="d-flex mt-3" role="search">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-success" type="submit">Search</button>
            </form>
          </div>
        </div>
      </div>
    </nav>
    <div class="row content dark-800">
      <div id="container-left" class="col-xxl-2 col-xl-2 col-lg-3 col-md-3 col-sm-3 d-none d-sm-block text-bg-dark pe-0" style="height: 100vh; overflow: auto;">
        <div class="card">
          <div class="card-body">

            {% for item in chats %}
             

            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"><i class="fas fa-comment-alt px-2"></i> {{item.title}}</p>
      
              {% endfor %}
            <h5 class="card-title fs-6 text-muted">昨天</h5>
            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"><i class="fas fa-user px-2"></i> Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"><i class="fas fa-comment px-2"></i> Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"><i class="fas fa-comment-alt px-2"></i> ome quick example text to build on the card title and make up the bulk of the card's content.</p>


            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"> <i class="fas fa-envelope px-2"></i> Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"> <i class="fas fa-comment-dots px-2"></i> Some quick example text to build on the card title and make up the bulk of the card's content.</p>
            <p class="card-text overflow-hidden text-nowrap text-overflow fs-6"><i class="fas fa-user-friends px-2"></i> Some quick example text to build on the card title and make up the bulk of the card's content.</p> <p class="card-text overflow-hidden text-nowrap text-overflow">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
      

          </div>
        </div>
       
      </div>
      <div id="container-right" class="col-xxl-10 col-xl-10 col-md-9 col-sm-9 col-12" style="padding-left: 0; padding-right: 0; height: 100vh; overflow: auto">
       
        <ul class="list-group list-group-flush" id="list-group">
          {% for item in conversations %}
            {% if item.role == "user" %}
                <li class="list-group-item list-group-item-secondary dark-1000">
                  <div class="container container-sm drow pt-3 pb-3" style="color: rgba(255,255,255,.8)">
                    <div>
                      <div class="avator">u</div>
                    </div>
                    <div class="ps-4  flexible-column">
                      <div>{{item.content}}</div>
                    </div>
                    <div class="ps-4 d-none d-sm-block fixed-columnr" style="width: 140px" >
                      <div>这里是操作</div>
                    </div>
                  </div>
                </li>
            {% else %}
                <li class="list-group-item list-group-item-success dark-800">
                  <div class="container container-sm drow pt-3 pb-3" style="color: rgba(255,255,255,.8)">
                    <div><div class="avator" style="background-color: rgb(25, 195, 125);">g</div></div>
                    <div class="ps-4  flexible-column" >
                      {{item.content}}
                    </div>
                    <div>
                      <div class="ps-4 d-none d-sm-block" style="width: 140px">这里是操作</div>
                    </div>
                  </div>
                </li>

            {% endif%}
          {% endfor %}
        
        </ul>
        <nav class="navbar sticky-bottom dark-800 shadowas">
          

          <div class="d-flex flex-row container" style="color: rgba(255,255,255,.8)">
            <div class="p-2 flex-fill" > 
              <div class="input-group input-group-lg mb-3 mt-5 sendmsg">
                <input type="text" id="content" class="form-control dark-1000 border-0 focus-visible" placeholder="send a message..." aria-label="send a message..." aria-describedby="sendBtn">
                <button class="btn btn-outline-secondary border-0" type="button" id="sendBtn">
                  <i class="fas fa-paper-plane"></i>
                </button>
              
              </div>
            </div>
          </div>
        </nav>
      </div>
    
    </div>
  
  </div>
  
  <script
  src="https://code.jquery.com/jquery-3.7.0.min.js"
  integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g="
  crossorigin="anonymous"></script>
  {{ bootstrap.load_js() }}
  <script src="{{ url_for('main.static', filename='highlight/highlight.min.js')}}"></script>
  <script src="{{ url_for('main.static', filename='marked.min.js')}}"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  <script>
    window.onload = function(){
      let conversations = []
      const sendBtn = document.getElementById("sendBtn")
      const listGroup = document.getElementById("list-group")


      
      // const newChat = document.getElementById("newChat")

      sendBtn.addEventListener("click", () => {
        const content = document.getElementById("content")
  
        $("#list-group").append(`<li class="list-group-item list-group-item-secondary dark-1000">
          <div class="container container-sm drow pt-3 pb-3" style="color: rgba(255,255,255,.8)">
            <div>
              <div class="avator">u</div>
            </div>
            <div class="ps-4  flexible-column">
              <div>${content.value}</div>
            </div>
            
          </div>
        </li>
        
        <li class="list-group-item list-group-item-success dark-800">
          <div class="container container-sm drow pt-3 pb-3" style="color: rgba(255,255,255,.8)">
            <div><div class="avator" style="background-color: rgb(25, 195, 125);">g</div></div>
            <div class="ps-4 flexible-column tt" >
              
            </div>
            <div class="ps-4 d-none d-sm-block fixed-columnr" style="width: 140px" >
              <div>这里是操作</div>
            </div>
          </div>
        </li>`)
     
        /* const eventSource = new EventSource(`/events?content=${content[0].value}
        &chatid=${conversations[0].id}&title=${conversations[0].title}`, { withCredentials: true, charset: 'utf-8' });
        */
        const eventSource = new EventSource(`/chat?content=${content.value}`, { withCredentials: true, charset: 'utf-8' });
        let k = []
        eventSource.onmessage = function (event) {
            // k.push(event.data.decode("utf-8"))
            data = JSON.parse(event.data).join("")
            console.log("获取到的数据：", data)
            $(".tt").last().html(marked.parse(data))
            // document.getElementById('events').innerHTML = marked.parse(data)
            // hljs.highlightAll();
            hljs.initHighlightingOnLoad();

            var container_right = $("#container-right");

            // 滚动到底部
            container_right.scrollTop(container_right[0].scrollHeight);
        };

        
        eventSource.onopen = function(event) {
          // 连接已打开
          console.log("连接已打开: ", event)
    
        };
        
        eventSource.onerror = function(event) {
          // 发生错误
          console.log("发生错误: ", event)
          eventSource.close()
        };
        
        eventSource.onclose = function(event) {
          // 连接已关闭
          console.log("连接已关闭: ", event)
     
    
        };
      })
      
      /**newChat.addEventListener("click", () => {
        const chat = document.getElementsByName("chat")
        console.log(chat[0].value)
        const conversation = {id: Math.random(), title: chat[0].value}
        locConversations = localStorage.getItem("conversations")
        if (locConversations) {
          conversations = JSON.parse(locConversations)
          conversations.push(conversation)
          localStorage.setItem("conversations", JSON.stringify(conversations))

        } else {
          localStorage.setItem("conversations", JSON.stringify([conversation]))
          conversations = [conversation]
        }
        console.log("conversations: ", conversations)
      }) **/
      
    }
   
  </script>

</body>
